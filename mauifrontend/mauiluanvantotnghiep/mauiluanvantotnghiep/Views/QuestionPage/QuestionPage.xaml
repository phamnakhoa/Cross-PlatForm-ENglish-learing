<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="mauiluanvantotnghiep.Views.QuestionPage.QuestionPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:conv="clr-namespace:mauiluanvantotnghiep.Converters"
    xmlns:sel="clr-namespace:mauiluanvantotnghiep.Selectors"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:vm="clr-namespace:mauiluanvantotnghiep.ViewModels"
    x:Name="questionPage"
    Title="BÃ i Táº­p">

    <!--  Enhanced Gradient Background  -->
    <ContentPage.Background>
        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
            <GradientStop Offset="0.0" Color="#667eea" />
            <GradientStop Offset="0.3" Color="#764ba2" />
            <GradientStop Offset="0.7" Color="#f093fb" />
            <GradientStop Offset="1.0" Color="#f5576c" />
        </LinearGradientBrush>
    </ContentPage.Background>

    <ContentPage.BindingContext>
        <vm:QuestionPageViewModel />
    </ContentPage.BindingContext>

    <!--  Enhanced Resources vá»›i nhiá»u styles má»›i  -->
    <ContentPage.Resources>
        <!--  Converters  -->
        <conv:VideoEmbedHtmlConverter x:Key="VideoEmbedHtmlConverter" />

        <conv:StringNotNullOrEmptyConverter x:Key="StringNotNullOrEmptyConverter" />
        <conv:InverseBooleanConverter x:Key="InverseBooleanConverter" />
        <conv:HtmlWrapperConverter x:Key="HtmlWrapperConverter" />
        <conv:IndexToDisplayConverter x:Key="IndexToDisplayConverter" />
        <conv:ProgressConverter x:Key="ProgressConverter" />
        <!--  ThÃªm converter má»›i  -->

        <!--  Modern Styles  -->
        <Style x:Key="QuestionTitleStyle" TargetType="Label">
            <Setter Property="FontAttributes" Value="Bold" />
            <Setter Property="FontSize" Value="22" />
            <Setter Property="TextColor" Value="White" />
            <Setter Property="LineBreakMode" Value="WordWrap" />
            <Setter Property="HorizontalTextAlignment" Value="Center" />
            <Setter Property="VerticalTextAlignment" Value="Center" />
        </Style>

        <Style x:Key="ModernFrameStyle" TargetType="Frame">
            <Setter Property="BackgroundColor" Value="White" />
            <Setter Property="BorderColor" Value="Transparent" />
            <Setter Property="CornerRadius" Value="20" />
            <Setter Property="HasShadow" Value="True" />
            <Setter Property="Padding" Value="25" />
            <Setter Property="Margin" Value="10,15" />
        </Style>

        <Style x:Key="PremiumButtonStyle" TargetType="Button">
            <Setter Property="CornerRadius" Value="15" />
            <Setter Property="Padding" Value="15,10" />
            <Setter Property="FontAttributes" Value="Bold" />
            <Setter Property="FontSize" Value="14" />
            <Setter Property="TextTransform" Value="None" />
        </Style>

        <!--  Enhanced WebView Style - WIDER AND TALLER  -->
        <Style x:Key="EnhancedWebViewStyle" TargetType="WebView">
            <Setter Property="MinimumHeightRequest" Value="250" />
            <Setter Property="HeightRequest" Value="400" />
            <Setter Property="MaximumHeightRequest" Value="600" />
            <Setter Property="HorizontalOptions" Value="Fill" />
            <Setter Property="VerticalOptions" Value="Fill" />
            <Setter Property="Margin" Value="5" />
        </Style>

        <!--  Progress Bar Style - FIXED  -->
        <Style x:Key="ProgressBarStyle" TargetType="ProgressBar">
            <Setter Property="ProgressColor" Value="#4CAF50" />
            <Setter Property="BackgroundColor" Value="#E0E0E0" />
            <Setter Property="HeightRequest" Value="8" />
        </Style>

        <!--  MCQ Template - ENHANCED VERSION vá»›i number fix  -->
        <DataTemplate x:Key="MCQTemplate">
            <Grid
                Padding="10"
                RowDefinitions="Auto,*,Auto"
                RowSpacing="15">

                <!--  Header Section vá»›i Progress  -->
                <Frame
                    Grid.Row="0"
                    Margin="5,10"
                    BackgroundColor="#6C5CE7"
                    Style="{StaticResource ModernFrameStyle}">
                    <Grid RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="12">
                        <!--  Quiz Header  -->
                        <StackLayout
                            Grid.Row="0"
                            HorizontalOptions="Center"
                            Orientation="Horizontal">
                            <Label
                                FontSize="24"
                                Text="ðŸŽ¯"
                                VerticalOptions="Center" />
                            <Label
                                FontAttributes="Bold"
                                FontSize="18"
                                Text="BÃ€I Táº¬P TRáº®C NGHIá»†M"
                                TextColor="White"
                                VerticalOptions="Center" />
                        </StackLayout>

                        <!--  Progress Section vá»›i Äá»™ khÃ³ - UPDATED  -->
                        <Grid
                            Grid.Row="1"
                            ColumnDefinitions="*,Auto,*,Auto,*"
                            ColumnSpacing="15">
                            <StackLayout Grid.Column="0" HorizontalOptions="Start">
                                <Label
                                    FontSize="12"
                                    Opacity="0.8"
                                    Text="ðŸ“Š Tiáº¿n Ä‘á»™"
                                    TextColor="White" />
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="16"
                                    Text="{Binding BindingContext.CurrentIndex, Source={x:Reference questionPage}, Converter={StaticResource IndexToDisplayConverter}}"
                                    TextColor="White" />
                            </StackLayout>

                            <BoxView
                                Grid.Column="1"
                                BackgroundColor="White"
                                Opacity="0.3"
                                WidthRequest="1" />

                            <!--  THÃŠM: Äá»™ khÃ³  -->
                            <StackLayout Grid.Column="2" HorizontalOptions="Center">
                                <Label
                                    FontSize="12"
                                    Opacity="0.8"
                                    Text="ðŸŽ¯ Äá»™ khÃ³"
                                    TextColor="White" />
                                <Border
                                    Padding="8,4"
                                    BackgroundColor="#FF6B35"
                                    Stroke="White"
                                    StrokeThickness="1">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="10" />
                                    </Border.StrokeShape>
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="12"
                                        HorizontalTextAlignment="Center"
                                        Text="{Binding QuestionLevelName}"
                                        TextColor="White" />
                                </Border>
                            </StackLayout>

                            <BoxView
                                Grid.Column="3"
                                BackgroundColor="White"
                                Opacity="0.3"
                                WidthRequest="1" />

                            <StackLayout Grid.Column="4" HorizontalOptions="End">
                                <Label
                                    FontSize="12"
                                    Opacity="0.8"
                                    Text="ðŸ“ Tá»•ng sá»‘"
                                    TextColor="White" />
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="16"
                                    Text="{Binding BindingContext.Questions.Count, Source={x:Reference questionPage}, StringFormat='{0} '}"
                                    TextColor="White" />
                            </StackLayout>
                        </Grid>

                        <!--  Progress Bar - Sá»¬A Láº I  -->
                        <ProgressBar
                            Grid.Row="2"
                            BackgroundColor="#E0E0E0"
                            HeightRequest="8"
                            ProgressColor="#4CAF50">
                            <ProgressBar.Progress>
                                <MultiBinding Converter="{StaticResource ProgressConverter}">
                                    <Binding Path="BindingContext.CurrentIndex" Source="{x:Reference questionPage}" />
                                    <Binding Path="BindingContext.Questions.Count" Source="{x:Reference questionPage}" />
                                </MultiBinding>
                            </ProgressBar.Progress>
                        </ProgressBar>

                        <!--  Question Title  -->
                        <Border
                            Grid.Row="3"
                            Padding="15"
                            BackgroundColor="White"
                            StrokeShape="RoundRectangle 12">
                            <Label
                                MinimumHeightRequest="50"
                                Style="{StaticResource QuestionTitleStyle}"
                                Text="{Binding QuestionText}"
                                TextColor="#2C3E50" />
                        </Border>
                    </Grid>
                </Frame>

                <!--  Main Content Area  -->
                <ScrollView Grid.Row="1">
                    <StackLayout Spacing="20">
                        <!--  Enhanced WebView Container - MUCH WIDER  -->
                        <!--  Enhanced WebView Container - MUCH WIDER  -->
                        <Frame
                            Padding="15"
                            IsVisible="{Binding QuestionDescription, Converter={StaticResource StringNotNullOrEmptyConverter}}"
                            Style="{StaticResource ModernFrameStyle}">
                            <Frame
                                Padding="0"
                                CornerRadius="15"
                                HasShadow="True">
                                <Frame.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                        <GradientStop Offset="0.0" Color="#667eea" />
                                        <GradientStop Offset="0.5" Color="#764ba2" />
                                        <GradientStop Offset="1.0" Color="#f093fb" />
                                    </LinearGradientBrush>
                                </Frame.Background>

                                <WebView
                                    x:Name="questionWebViewVideo"
                                    HeightRequest="160"
                                    Source="{Binding QuestionDescription, Converter={StaticResource VideoEmbedHtmlConverter}}"
                                    Style="{StaticResource EnhancedWebViewStyle}" />

                            </Frame>


                        </Frame>

                        <!--  Enhanced Options Container  -->
                        <Frame Style="{StaticResource ModernFrameStyle}">
                            <StackLayout Spacing="15">
                                <StackLayout HorizontalOptions="Center" Orientation="Horizontal">
                                    <Label
                                        FontSize="18"
                                        Text="ðŸ“‹"
                                        VerticalOptions="Center" />
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="16"
                                        Text="Chá»n Ä‘Ã¡p Ã¡n Ä‘Ãºng:"
                                        TextColor="#2C3E50" />
                                </StackLayout>

                                <CollectionView ItemsSource="{Binding Options}" SelectionMode="None">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Border
                                                Margin="0,8"
                                                Padding="20"
                                                BackgroundColor="{Binding BackgroundColor}"
                                                Stroke="Transparent"
                                                StrokeThickness="0">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="15" />
                                                </Border.StrokeShape>
                                                <Border.Triggers>
                                                    <!--  GIá»® Láº I chá»‰ MultiTrigger nÃ y  -->
                                                    <MultiTrigger TargetType="Border">
                                                        <MultiTrigger.Conditions>
                                                            <BindingCondition Binding="{Binding IsSelected}" Value="True" />
                                                            <BindingCondition Binding="{Binding BindingContext.IsAnswerSubmitted, Source={x:Reference questionPage}}" Value="False" />
                                                        </MultiTrigger.Conditions>
                                                        <MultiTrigger.Setters>
                                                            <Setter Property="Stroke" Value="#4CAF50" />
                                                            <Setter Property="StrokeThickness" Value="3" />
                                                            <Setter Property="BackgroundColor" Value="#F0F8F0" />
                                                        </MultiTrigger.Setters>
                                                    </MultiTrigger>

                                                    <!--  GIá»® Láº I DataTrigger cho submit  -->
                                                    <DataTrigger
                                                        Binding="{Binding BindingContext.IsAnswerSubmitted, Source={x:Reference questionPage}}"
                                                        TargetType="Border"
                                                        Value="True">
                                                        <Setter Property="BackgroundColor" Value="{Binding BackgroundColor}" />
                                                        <Setter Property="Stroke" Value="Transparent" />
                                                        <Setter Property="StrokeThickness" Value="0" />
                                                    </DataTrigger>
                                                </Border.Triggers>
                                                <RadioButton
                                                    Content="{Binding Text}"
                                                    FontSize="16"
                                                    GroupName="MCQOptions"
                                                    IsChecked="{Binding IsSelected, Mode=TwoWay}"
                                                    TextColor="#2C3E50" />
                                            </Border>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </StackLayout>
                        </Frame>

                        <!--  Enhanced Explanation Area  -->
                        <Frame
                            BackgroundColor="#FFF8E1"
                            IsVisible="{Binding IsAnswerSubmitted}"
                            Style="{StaticResource ModernFrameStyle}">
                            <StackLayout Spacing="12">
                                <StackLayout HorizontalOptions="Center" Orientation="Horizontal">
                                    <Label FontSize="20" Text="ðŸŽ“" />
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="16"
                                        Text="GIáº¢I THÃCH CHI TIáº¾T"
                                        TextColor="#F57C00" />
                                </StackLayout>
                                <BoxView
                                    BackgroundColor="#FFB74D"
                                    CornerRadius="1"
                                    HeightRequest="2" />

                                <!--  Thay tháº¿ Label báº±ng WebView  -->
                                <Frame
                                    Padding="0"
                                    BackgroundColor="White"
                                    CornerRadius="15"
                                    HasShadow="True">
                                    <WebView
                                        x:Name="explanationWebViewMCQ"
                                        HeightRequest="200"
                                        HorizontalOptions="Fill"
                                        Source="{Binding Explanation, Converter={StaticResource HtmlWrapperConverter}}"
                                        VerticalOptions="Fill" />
                                </Frame>
                            </StackLayout>
                        </Frame>
                    </StackLayout>
                </ScrollView>

                <!--  Enhanced Action Buttons - FIXED LAYOUT  -->
                <Frame
                    Grid.Row="2"
                    Margin="5,10"
                    BackgroundColor="#F8F9FA"
                    Style="{StaticResource ModernFrameStyle}">
                    <StackLayout Spacing="20">
                        <!--  Submit Button  -->
                        <Button
                            Command="{Binding SubmitAnswerCommand}"
                            IsVisible="{Binding IsAnswerSubmitted, Converter={StaticResource InverseBooleanConverter}}"
                            Style="{StaticResource PremiumButtonStyle}"
                            Text="ðŸŽ¯ KIá»‚M TRA Káº¾T QUáº¢"
                            TextColor="White">
                            <Button.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                    <GradientStop Offset="0.0" Color="#4CAF50" />
                                    <GradientStop Offset="1.0" Color="#45A049" />
                                </LinearGradientBrush>
                            </Button.Background>
                        </Button>

                        <!--  Navigation Buttons - FIXED vá»›i text ngáº¯n hÆ¡n  -->
                        <Grid
                            ColumnDefinitions="*,*"
                            ColumnSpacing="10"
                            RowDefinitions="Auto,Auto"
                            RowSpacing="10">
                            <Button
                                Grid.Row="0"
                                Grid.Column="0"
                                BackgroundColor="#757575"
                                Command="{Binding BindingContext.PrevCommand, Source={x:Reference questionPage}}"
                                IsEnabled="{Binding BindingContext.CanGoPrev, Source={x:Reference questionPage}}"
                                Style="{StaticResource PremiumButtonStyle}"
                                Text="â—€ TrÆ°á»›c"
                                TextColor="White" />

                            <Button
                                Grid.Row="0"
                                Grid.Column="1"
                                BackgroundColor="#2196F3"
                                Command="{Binding BindingContext.NextCommand, Source={x:Reference questionPage}}"
                                IsEnabled="{Binding BindingContext.CanGoNext, Source={x:Reference questionPage}}"
                                Style="{StaticResource PremiumButtonStyle}"
                                Text="Tiáº¿p â–¶"
                                TextColor="White" />

                            <Button
                                Grid.Row="1"
                                Grid.Column="0"
                                BackgroundColor="#FF9800"
                                Command="{Binding BindingContext.CompleteLessonCommand, Source={x:Reference questionPage}}"
                                IsVisible="{Binding BindingContext.IsLastQuestion, Source={x:Reference questionPage}}"
                                Style="{StaticResource PremiumButtonStyle}"
                                Text="ðŸ† HoÃ n thÃ nh"
                                TextColor="White" />

                            <Button
                                Grid.Row="1"
                                Grid.Column="1"
                                BackgroundColor="#9C27B0"
                                Command="{Binding BindingContext.BackToLessonsCommand, Source={x:Reference questionPage}}"
                                IsVisible="{Binding BindingContext.IsCompleted, Source={x:Reference questionPage}}"
                                Style="{StaticResource PremiumButtonStyle}"
                                Text="ðŸ”™ Quay vá»"
                                TextColor="White" />
                        </Grid>
                    </StackLayout>
                </Frame>
            </Grid>
        </DataTemplate>

        <!--  True/False Template - UPDATED vá»›i Äá»™ khÃ³  -->
        <DataTemplate x:Key="TFTemplate">
            <Grid
                Padding="10"
                RowDefinitions="Auto,*,Auto"
                RowSpacing="15">

                <!--  Header Section  -->
                <Frame
                    Grid.Row="0"
                    Margin="5,10"
                    BackgroundColor="#E91E63"
                    Style="{StaticResource ModernFrameStyle}">
                    <Grid RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="12">
                        <StackLayout
                            Grid.Row="0"
                            HorizontalOptions="Center"
                            Orientation="Horizontal">
                            <Label
                                FontSize="24"
                                Text="âœ…âŒ"
                                VerticalOptions="Center" />
                            <Label
                                FontAttributes="Bold"
                                FontSize="18"
                                Text="CÃ‚U Há»ŽI ÄÃšNG/SAI"
                                TextColor="White" />
                        </StackLayout>

                        <!--  Progress Section vá»›i Äá»™ khÃ³ - UPDATED  -->
                        <Grid
                            Grid.Row="1"
                            ColumnDefinitions="*,Auto,*,Auto,*"
                            ColumnSpacing="15">
                            <StackLayout Grid.Column="0" HorizontalOptions="Start">
                                <Label
                                    FontSize="12"
                                    Opacity="0.8"
                                    Text="ðŸ“Š Tiáº¿n Ä‘á»™"
                                    TextColor="White" />
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="16"
                                    Text="{Binding BindingContext.CurrentIndex, Source={x:Reference questionPage}, Converter={StaticResource IndexToDisplayConverter}}"
                                    TextColor="White" />
                            </StackLayout>

                            <BoxView
                                Grid.Column="1"
                                BackgroundColor="White"
                                Opacity="0.3"
                                WidthRequest="1" />

                            <!--  THÃŠM: Äá»™ khÃ³  -->
                            <StackLayout Grid.Column="2" HorizontalOptions="Center">
                                <Label
                                    FontSize="12"
                                    Opacity="0.8"
                                    Text="ðŸŽ¯ Äá»™ khÃ³"
                                    TextColor="White" />
                                <Border
                                    Padding="8,4"
                                    BackgroundColor="#FF6B35"
                                    Stroke="White"
                                    StrokeThickness="1">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="10" />
                                    </Border.StrokeShape>
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="12"
                                        HorizontalTextAlignment="Center"
                                        Text="{Binding QuestionLevelName}"
                                        TextColor="White" />
                                </Border>
                            </StackLayout>

                            <BoxView
                                Grid.Column="3"
                                BackgroundColor="White"
                                Opacity="0.3"
                                WidthRequest="1" />

                            <StackLayout Grid.Column="4" HorizontalOptions="End">
                                <Label
                                    FontSize="12"
                                    Opacity="0.8"
                                    Text="ðŸ“ Tá»•ng sá»‘"
                                    TextColor="White" />
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="16"
                                    Text="{Binding BindingContext.Questions.Count, Source={x:Reference questionPage}, StringFormat='{0} '}"
                                    TextColor="White" />
                            </StackLayout>
                        </Grid>

                        <!--  Progress Bar - Sá»¬A Láº I cho TFTemplate  -->
                        <ProgressBar
                            Grid.Row="2"
                            BackgroundColor="#E0E0E0"
                            HeightRequest="8"
                            ProgressColor="#4CAF50">
                            <ProgressBar.Progress>
                                <MultiBinding Converter="{StaticResource ProgressConverter}">
                                    <Binding Path="BindingContext.CurrentIndex" Source="{x:Reference questionPage}" />
                                    <Binding Path="BindingContext.Questions.Count" Source="{x:Reference questionPage}" />
                                </MultiBinding>
                            </ProgressBar.Progress>
                        </ProgressBar>

                        <!--  Question Title  -->
                        <Border
                            Grid.Row="3"
                            Padding="15"
                            BackgroundColor="White"
                            StrokeShape="RoundRectangle 12">
                            <Label
                                MinimumHeightRequest="50"
                                Style="{StaticResource QuestionTitleStyle}"
                                Text="{Binding QuestionText}"
                                TextColor="#2C3E50" />
                        </Border>
                    </Grid>
                </Frame>

                <ScrollView Grid.Row="1">
                    <StackLayout Spacing="20">
                        <!--  Enhanced WebView - WIDER  -->
                        <!--  Enhanced WebView - WIDER  -->
                        <Frame
                            Padding="15"
                            IsVisible="{Binding QuestionDescription, Converter={StaticResource StringNotNullOrEmptyConverter}}"
                            Style="{StaticResource ModernFrameStyle}">
                            <Frame
                                Padding="0"
                                CornerRadius="15"
                                HasShadow="True">
                                <Frame.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                        <GradientStop Offset="0.0" Color="#FF6B6B" />
                                        <GradientStop Offset="0.5" Color="#EE5A24" />
                                        <GradientStop Offset="1.0" Color="#FF9FF3" />
                                    </LinearGradientBrush>
                                </Frame.Background>
                                <WebView
                                    x:Name="questionWebViewTF"
                                    Source="{Binding QuestionDescription, Converter={StaticResource HtmlWrapperConverter}}"
                                    Style="{StaticResource EnhancedWebViewStyle}" />
                            </Frame>
                        </Frame>

                        <!--  Options Container  -->
                        <Frame Style="{StaticResource ModernFrameStyle}">
                            <StackLayout Spacing="15">
                                <StackLayout HorizontalOptions="Center" Orientation="Horizontal">
                                    <Label FontSize="18" Text="ðŸ¤”" />
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="16"
                                        Text="PhÃ¡t biá»ƒu nÃ y Ä‘Ãºng hay sai?"
                                        TextColor="#2C3E50" />
                                </StackLayout>

                                <CollectionView ItemsSource="{Binding Options}" SelectionMode="None">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Border
                                                Margin="0,8"
                                                Padding="20"
                                                BackgroundColor="{Binding BackgroundColor}"
                                                Stroke="Transparent"
                                                StrokeThickness="0">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="15" />
                                                </Border.StrokeShape>
                                                <Border.Triggers>
                                                    <!--  GIá»® Láº I chá»‰ MultiTrigger nÃ y  -->
                                                    <MultiTrigger TargetType="Border">
                                                        <MultiTrigger.Conditions>
                                                            <BindingCondition Binding="{Binding IsSelected}" Value="True" />
                                                            <BindingCondition Binding="{Binding BindingContext.IsAnswerSubmitted, Source={x:Reference questionPage}}" Value="False" />
                                                        </MultiTrigger.Conditions>
                                                        <MultiTrigger.Setters>
                                                            <Setter Property="Stroke" Value="#4CAF50" />
                                                            <Setter Property="StrokeThickness" Value="3" />
                                                            <Setter Property="BackgroundColor" Value="#F0F8F0" />
                                                        </MultiTrigger.Setters>
                                                    </MultiTrigger>

                                                    <!--  GIá»® Láº I DataTrigger cho submit  -->
                                                    <DataTrigger
                                                        Binding="{Binding BindingContext.IsAnswerSubmitted, Source={x:Reference questionPage}}"
                                                        TargetType="Border"
                                                        Value="True">
                                                        <Setter Property="BackgroundColor" Value="{Binding BackgroundColor}" />
                                                        <Setter Property="Stroke" Value="Transparent" />
                                                        <Setter Property="StrokeThickness" Value="0" />
                                                    </DataTrigger>
                                                </Border.Triggers>
                                                <RadioButton
                                                    Content="{Binding Text}"
                                                    FontSize="16"
                                                    GroupName="TFOptions"
                                                    IsChecked="{Binding IsSelected, Mode=TwoWay}"
                                                    TextColor="#2C3E50" />
                                            </Border>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </StackLayout>
                        </Frame>

                        <!--  Explanation  -->
                        <!--  Explanation  -->
                        <Frame
                            BackgroundColor="#FFF8E1"
                            IsVisible="{Binding IsAnswerSubmitted}"
                            Style="{StaticResource ModernFrameStyle}">
                            <StackLayout Spacing="12">
                                <StackLayout HorizontalOptions="Center" Orientation="Horizontal">
                                    <Label FontSize="20" Text="ðŸŽ“" />
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="16"
                                        Text="GIáº¢I THÃCH CHI TIáº¾T"
                                        TextColor="#F57C00" />
                                </StackLayout>
                                <BoxView
                                    BackgroundColor="#FFB74D"
                                    CornerRadius="1"
                                    HeightRequest="2" />

                                <!--  Thay tháº¿ Label báº±ng WebView  -->
                                <Frame
                                    Padding="0"
                                    BackgroundColor="White"
                                    CornerRadius="15"
                                    HasShadow="True">
                                    <WebView
                                        x:Name="explanationWebViewTF"
                                        HeightRequest="200"
                                        HorizontalOptions="Fill"
                                        Source="{Binding Explanation, Converter={StaticResource HtmlWrapperConverter}}"
                                        VerticalOptions="Fill" />
                                </Frame>
                            </StackLayout>
                        </Frame>
                    </StackLayout>
                </ScrollView>

                <!--  Action Buttons  -->
                <Frame
                    Grid.Row="2"
                    Margin="5,10"
                    BackgroundColor="#F8F9FA"
                    Style="{StaticResource ModernFrameStyle}">
                    <StackLayout Spacing="20">
                        <Button
                            Command="{Binding SubmitAnswerCommand}"
                            IsVisible="{Binding IsAnswerSubmitted, Converter={StaticResource InverseBooleanConverter}}"
                            Style="{StaticResource PremiumButtonStyle}"
                            Text="ðŸŽ¯ KIá»‚M TRA Káº¾T QUáº¢"
                            TextColor="White">
                            <Button.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                    <GradientStop Offset="0.0" Color="#4CAF50" />
                                    <GradientStop Offset="1.0" Color="#45A049" />
                                </LinearGradientBrush>
                            </Button.Background>
                        </Button>

                        <Grid
                            ColumnDefinitions="*,*"
                            ColumnSpacing="10"
                            RowDefinitions="Auto,Auto"
                            RowSpacing="10">
                            <Button
                                Grid.Row="0"
                                Grid.Column="0"
                                BackgroundColor="#757575"
                                Command="{Binding BindingContext.PrevCommand, Source={x:Reference questionPage}}"
                                IsEnabled="{Binding BindingContext.CanGoPrev, Source={x:Reference questionPage}}"
                                Style="{StaticResource PremiumButtonStyle}"
                                Text="â—€ TrÆ°á»›c"
                                TextColor="White" />
                            <Button
                                Grid.Row="0"
                                Grid.Column="1"
                                BackgroundColor="#2196F3"
                                Command="{Binding BindingContext.NextCommand, Source={x:Reference questionPage}}"
                                IsEnabled="{Binding BindingContext.CanGoNext, Source={x:Reference questionPage}}"
                                Style="{StaticResource PremiumButtonStyle}"
                                Text="Tiáº¿p â–¶"
                                TextColor="White" />
                            <Button
                                Grid.Row="1"
                                Grid.Column="0"
                                BackgroundColor="#FF9800"
                                Command="{Binding BindingContext.CompleteLessonCommand, Source={x:Reference questionPage}}"
                                IsVisible="{Binding BindingContext.IsLastQuestion, Source={x:Reference questionPage}}"
                                Style="{StaticResource PremiumButtonStyle}"
                                Text="ðŸ† HoÃ n thÃ nh"
                                TextColor="White" />
                            <Button
                                Grid.Row="1"
                                Grid.Column="1"
                                BackgroundColor="#9C27B0"
                                Command="{Binding BindingContext.BackToLessonsCommand, Source={x:Reference questionPage}}"
                                IsVisible="{Binding BindingContext.IsCompleted, Source={x:Reference questionPage}}"
                                Style="{StaticResource PremiumButtonStyle}"
                                Text="ðŸ”™ Quay vá»"
                                TextColor="White" />
                        </Grid>
                    </StackLayout>
                </Frame>
            </Grid>
        </DataTemplate>

        <!--  Fill Blank Template - UPDATED vá»›i Äá»™ khÃ³  -->
        <DataTemplate x:Key="FillBlankTemplate">
            <Grid
                Padding="10"
                RowDefinitions="Auto,*,Auto"
                RowSpacing="15">
                <Frame
                    Grid.Row="0"
                    Margin="5,10"
                    BackgroundColor="#9C27B0"
                    Style="{StaticResource ModernFrameStyle}">
                    <Grid RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="12">
                        <StackLayout
                            Grid.Row="0"
                            HorizontalOptions="Center"
                            Orientation="Horizontal">
                            <Label
                                FontSize="24"
                                Text="âœï¸"
                                VerticalOptions="Center" />
                            <Label
                                FontAttributes="Bold"
                                FontSize="18"
                                Text="CÃ‚U Há»ŽI ÄIá»€N Tá»ª"
                                TextColor="White" />
                        </StackLayout>

                        <!--  Progress Section vá»›i Äá»™ khÃ³ - UPDATED  -->
                        <Grid
                            Grid.Row="1"
                            ColumnDefinitions="*,Auto,*,Auto,*"
                            ColumnSpacing="15">
                            <StackLayout Grid.Column="0" HorizontalOptions="Start">
                                <Label
                                    FontSize="12"
                                    Opacity="0.8"
                                    Text="ðŸ“Š Tiáº¿n Ä‘á»™"
                                    TextColor="White" />
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="16"
                                    Text="{Binding BindingContext.CurrentIndex, Source={x:Reference questionPage}, Converter={StaticResource IndexToDisplayConverter}}"
                                    TextColor="White" />
                            </StackLayout>

                            <BoxView
                                Grid.Column="1"
                                BackgroundColor="White"
                                Opacity="0.3"
                                WidthRequest="1" />

                            <!--  THÃŠM: Äá»™ khÃ³  -->
                            <StackLayout Grid.Column="2" HorizontalOptions="Center">
                                <Label
                                    FontSize="12"
                                    Opacity="0.8"
                                    Text="ðŸŽ¯ Äá»™ khÃ³"
                                    TextColor="White" />
                                <Border
                                    Padding="8,4"
                                    BackgroundColor="#FF6B35"
                                    Stroke="White"
                                    StrokeThickness="1">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="10" />
                                    </Border.StrokeShape>
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="12"
                                        HorizontalTextAlignment="Center"
                                        Text="{Binding QuestionLevelName}"
                                        TextColor="White" />
                                </Border>
                            </StackLayout>

                            <BoxView
                                Grid.Column="3"
                                BackgroundColor="White"
                                Opacity="0.3"
                                WidthRequest="1" />

                            <StackLayout Grid.Column="4" HorizontalOptions="End">
                                <Label
                                    FontSize="12"
                                    Opacity="0.8"
                                    Text="ðŸ“ Tá»•ng sá»‘"
                                    TextColor="White" />
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="16"
                                    Text="{Binding BindingContext.Questions.Count, Source={x:Reference questionPage}, StringFormat='{0} '}"
                                    TextColor="White" />
                            </StackLayout>
                        </Grid>

                        <!--  Progress Bar - Sá»¬A Láº I cho FillBlankTemplate  -->
                        <ProgressBar
                            Grid.Row="2"
                            BackgroundColor="#E0E0E0"
                            HeightRequest="8"
                            ProgressColor="#4CAF50">
                            <ProgressBar.Progress>
                                <MultiBinding Converter="{StaticResource ProgressConverter}">
                                    <Binding Path="BindingContext.CurrentIndex" Source="{x:Reference questionPage}" />
                                    <Binding Path="BindingContext.Questions.Count" Source="{x:Reference questionPage}" />
                                </MultiBinding>
                            </ProgressBar.Progress>
                        </ProgressBar>

                        <Border
                            Grid.Row="3"
                            Padding="15"
                            BackgroundColor="White"
                            StrokeShape="RoundRectangle 12">
                            <Label
                                MinimumHeightRequest="50"
                                Style="{StaticResource QuestionTitleStyle}"
                                Text="{Binding QuestionText}"
                                TextColor="#2C3E50" />
                        </Border>
                    </Grid>
                </Frame>

                <ScrollView Grid.Row="1">
                    <StackLayout Spacing="20">
                        <!--  Enhanced WebView  -->
                        <!--  Enhanced WebView  -->
                        <Frame
                            Padding="15"
                            IsVisible="{Binding QuestionDescription, Converter={StaticResource StringNotNullOrEmptyConverter}}"
                            Style="{StaticResource ModernFrameStyle}">
                            <Frame
                                Padding="0"
                                CornerRadius="15"
                                HasShadow="True">
                                <Frame.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                        <GradientStop Offset="0.0" Color="#A8E6CF" />
                                        <GradientStop Offset="0.5" Color="#88D8A3" />
                                        <GradientStop Offset="1.0" Color="#9B59B6" />
                                    </LinearGradientBrush>
                                </Frame.Background>
                                <WebView
                                    x:Name="questionWebViewFB"
                                    Source="{Binding QuestionDescription, Converter={StaticResource HtmlWrapperConverter}}"
                                    Style="{StaticResource EnhancedWebViewStyle}" />
                            </Frame>
                        </Frame>
                        <!--  Answer Input  -->
                        <Frame Style="{StaticResource ModernFrameStyle}">
                            <StackLayout Spacing="15">
                                <StackLayout HorizontalOptions="Center" Orientation="Horizontal">
                                    <Label FontSize="18" Text="ðŸ’­" />
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="16"
                                        Text="Nháº­p Ä‘Ã¡p Ã¡n cá»§a báº¡n:"
                                        TextColor="#2C3E50" />
                                </StackLayout>

                                <Border
                                    Padding="20"
                                    BackgroundColor="White"
                                    Stroke="{Binding FillBlankBorderColor}"
                                    StrokeThickness="3">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="15" />
                                    </Border.StrokeShape>
                                    <Entry
                                        FontSize="18"
                                        Placeholder="ðŸ’­ Äiá»n Ä‘Ã¡p Ã¡n cá»§a báº¡n vÃ o Ä‘Ã¢y..."
                                        PlaceholderColor="#999999"
                                        Text="{Binding UserAnswer, Mode=TwoWay}" />
                                </Border>
                            </StackLayout>
                        </Frame>

                        <!--  Explanation  -->
                        <!--  Explanation  -->
                        <Frame
                            BackgroundColor="#FFF8E1"
                            IsVisible="{Binding IsAnswerSubmitted}"
                            Style="{StaticResource ModernFrameStyle}">
                            <StackLayout Spacing="12">
                                <StackLayout HorizontalOptions="Center" Orientation="Horizontal">
                                    <Label FontSize="20" Text="ðŸŽ“" />
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="16"
                                        Text="GIáº¢I THÃCH CHI TIáº¾T"
                                        TextColor="#F57C00" />
                                </StackLayout>
                                <BoxView
                                    BackgroundColor="#FFB74D"
                                    CornerRadius="1"
                                    HeightRequest="2" />

                                <!--  Thay tháº¿ Label báº±ng WebView  -->
                                <Frame
                                    Padding="0"
                                    BackgroundColor="White"
                                    CornerRadius="15"
                                    HasShadow="True">
                                    <WebView
                                        x:Name="explanationWebViewFB"
                                        HeightRequest="200"
                                        HorizontalOptions="Fill"
                                        Source="{Binding Explanation, Converter={StaticResource HtmlWrapperConverter}}"
                                        VerticalOptions="Fill" />
                                </Frame>
                            </StackLayout>
                        </Frame>
                    </StackLayout>
                </ScrollView>

                <!--  Action Buttons  -->
                <Frame
                    Grid.Row="2"
                    Margin="5,10"
                    BackgroundColor="#F8F9FA"
                    Style="{StaticResource ModernFrameStyle}">
                    <StackLayout Spacing="20">
                        <Button
                            Command="{Binding SubmitAnswerCommand}"
                            IsVisible="{Binding IsAnswerSubmitted, Converter={StaticResource InverseBooleanConverter}}"
                            Style="{StaticResource PremiumButtonStyle}"
                            Text="ðŸŽ¯ KIá»‚M TRA Káº¾T QUáº¢"
                            TextColor="White">
                            <Button.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                    <GradientStop Offset="0.0" Color="#4CAF50" />
                                    <GradientStop Offset="1.0" Color="#45A049" />
                                </LinearGradientBrush>
                            </Button.Background>
                        </Button>

                        <Grid
                            ColumnDefinitions="*,*"
                            ColumnSpacing="10"
                            RowDefinitions="Auto,Auto"
                            RowSpacing="10">
                            <Button
                                Grid.Row="0"
                                Grid.Column="0"
                                BackgroundColor="#757575"
                                Command="{Binding BindingContext.PrevCommand, Source={x:Reference questionPage}}"
                                IsEnabled="{Binding BindingContext.CanGoPrev, Source={x:Reference questionPage}}"
                                Style="{StaticResource PremiumButtonStyle}"
                                Text="â—€ TrÆ°á»›c"
                                TextColor="White" />
                            <Button
                                Grid.Row="0"
                                Grid.Column="1"
                                BackgroundColor="#2196F3"
                                Command="{Binding BindingContext.NextCommand, Source={x:Reference questionPage}}"
                                IsEnabled="{Binding BindingContext.CanGoNext, Source={x:Reference questionPage}}"
                                Style="{StaticResource PremiumButtonStyle}"
                                Text="Tiáº¿p â–¶"
                                TextColor="White" />
                            <Button
                                Grid.Row="1"
                                Grid.Column="0"
                                BackgroundColor="#FF9800"
                                Command="{Binding BindingContext.CompleteLessonCommand, Source={x:Reference questionPage}}"
                                IsVisible="{Binding BindingContext.IsLastQuestion, Source={x:Reference questionPage}}"
                                Style="{StaticResource PremiumButtonStyle}"
                                Text="ðŸ† HoÃ n thÃ nh"
                                TextColor="White" />
                            <Button
                                Grid.Row="1"
                                Grid.Column="1"
                                BackgroundColor="#9C27B0"
                                Command="{Binding BindingContext.BackToLessonsCommand, Source={x:Reference questionPage}}"
                                IsVisible="{Binding BindingContext.IsCompleted, Source={x:Reference questionPage}}"
                                Style="{StaticResource PremiumButtonStyle}"
                                Text="ðŸ”™ Quay vá»"
                                TextColor="White" />
                        </Grid>
                    </StackLayout>
                </Frame>
            </Grid>
        </DataTemplate>

        <!--  Audio Template - UPDATED vá»›i Äá»™ khÃ³  -->
        <DataTemplate x:Key="AudioTemplate">
            <Grid
                Padding="10"
                RowDefinitions="Auto,*,Auto"
                RowSpacing="15">
                <Frame
                    Grid.Row="0"
                    Margin="5,10"
                    BackgroundColor="#FF5722"
                    Style="{StaticResource ModernFrameStyle}">
                    <Grid RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="12">
                        <StackLayout
                            Grid.Row="0"
                            HorizontalOptions="Center"
                            Orientation="Horizontal">
                            <Label
                                FontSize="24"
                                Text="ðŸŽ§"
                                VerticalOptions="Center" />
                            <Label
                                FontAttributes="Bold"
                                FontSize="18"
                                Text="CÃ‚U Há»ŽI NGHE"
                                TextColor="White" />
                        </StackLayout>

                        <!--  Progress Section vá»›i Äá»™ khÃ³ - UPDATED  -->
                        <Grid
                            Grid.Row="1"
                            ColumnDefinitions="*,Auto,*,Auto,*"
                            ColumnSpacing="15">
                            <StackLayout Grid.Column="0" HorizontalOptions="Start">
                                <Label
                                    FontSize="12"
                                    Opacity="0.8"
                                    Text="ðŸ“Š Tiáº¿n Ä‘á»™"
                                    TextColor="White" />
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="16"
                                    Text="{Binding BindingContext.CurrentIndex, Source={x:Reference questionPage}, Converter={StaticResource IndexToDisplayConverter}}"
                                    TextColor="White" />
                            </StackLayout>

                            <BoxView
                                Grid.Column="1"
                                BackgroundColor="White"
                                Opacity="0.3"
                                WidthRequest="1" />

                            <!--  THÃŠM: Äá»™ khÃ³  -->
                            <StackLayout Grid.Column="2" HorizontalOptions="Center">
                                <Label
                                    FontSize="12"
                                    Opacity="0.8"
                                    Text="ðŸŽ¯ Äá»™ khÃ³"
                                    TextColor="White" />
                                <Border
                                    Padding="8,4"
                                    BackgroundColor="#FF6B35"
                                    Stroke="White"
                                    StrokeThickness="1">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="10" />
                                    </Border.StrokeShape>
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="12"
                                        HorizontalTextAlignment="Center"
                                        Text="{Binding QuestionLevelName}"
                                        TextColor="White" />
                                </Border>
                            </StackLayout>

                            <BoxView
                                Grid.Column="3"
                                BackgroundColor="White"
                                Opacity="0.3"
                                WidthRequest="1" />

                            <StackLayout Grid.Column="4" HorizontalOptions="End">
                                <Label
                                    FontSize="12"
                                    Opacity="0.8"
                                    Text="ðŸ“ Tá»•ng sá»‘"
                                    TextColor="White" />
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="16"
                                    Text="{Binding BindingContext.Questions.Count, Source={x:Reference questionPage}, StringFormat='{0} '}"
                                    TextColor="White" />
                            </StackLayout>
                        </Grid>

                        <!--  Progress Bar - Sá»¬A Láº I cho AudioTemplate  -->
                        <ProgressBar
                            Grid.Row="2"
                            BackgroundColor="#E0E0E0"
                            HeightRequest="8"
                            ProgressColor="#4CAF50">
                            <ProgressBar.Progress>
                                <MultiBinding Converter="{StaticResource ProgressConverter}">
                                    <Binding Path="BindingContext.CurrentIndex" Source="{x:Reference questionPage}" />
                                    <Binding Path="BindingContext.Questions.Count" Source="{x:Reference questionPage}" />
                                </MultiBinding>
                            </ProgressBar.Progress>
                        </ProgressBar>

                        <!--  Question Title  -->
                        <Border
                            Grid.Row="3"
                            Padding="15"
                            BackgroundColor="White"
                            StrokeShape="RoundRectangle 12">
                            <Label
                                MinimumHeightRequest="50"
                                Style="{StaticResource QuestionTitleStyle}"
                                Text="{Binding QuestionText}"
                                TextColor="#2C3E50" />
                        </Border>
                    </Grid>
                </Frame>

                <ScrollView Grid.Row="1">
                    <StackLayout Spacing="20">
                        <!--  Enhanced WebView  -->
                        <!--  Enhanced WebView  -->
                        <Frame
                            Padding="15"
                            IsVisible="{Binding QuestionDescription, Converter={StaticResource StringNotNullOrEmptyConverter}}"
                            Style="{StaticResource ModernFrameStyle}">
                            <Frame
                                Padding="0"
                                CornerRadius="15"
                                HasShadow="True">
                                <Frame.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                        <GradientStop Offset="0.0" Color="#FFB74D" />
                                        <GradientStop Offset="0.5" Color="#FF8A65" />
                                        <GradientStop Offset="1.0" Color="#FF5722" />
                                    </LinearGradientBrush>
                                </Frame.Background>
                                <WebView
                                    x:Name="questionWebViewAudio"
                                    Source="{Binding QuestionDescription, Converter={StaticResource HtmlWrapperConverter}}"
                                    Style="{StaticResource EnhancedWebViewStyle}" />
                            </Frame>
                        </Frame>
                        <!--  Audio Input  -->
                        <Frame Style="{StaticResource ModernFrameStyle}">
                            <StackLayout Spacing="15">
                                <StackLayout HorizontalOptions="Center" Orientation="Horizontal">
                                    <Label FontSize="18" Text="ðŸŽµ" />
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="16"
                                        Text="Nháº­p tá»« báº¡n nghe Ä‘Æ°á»£c:"
                                        TextColor="#2C3E50" />
                                </StackLayout>

                                <CollectionView ItemsSource="{Binding Blanks}">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Border
                                                Margin="0,8"
                                                Padding="20"
                                                BackgroundColor="White"
                                                Stroke="{Binding BorderColor}"
                                                StrokeThickness="2">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="15" />
                                                </Border.StrokeShape>
                                                <Entry
                                                    FontSize="16"
                                                    Placeholder="ðŸŽµ Nháº­p tá»« nghe Ä‘Æ°á»£c..."
                                                    PlaceholderColor="#999999"
                                                    Text="{Binding UserText, Mode=TwoWay}" />
                                            </Border>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </StackLayout>
                        </Frame>

                        <!--  Explanation  -->
                        <!--  Explanation  -->
                        <Frame
                            BackgroundColor="#FFF8E1"
                            IsVisible="{Binding IsAnswerSubmitted}"
                            Style="{StaticResource ModernFrameStyle}">
                            <StackLayout Spacing="12">
                                <StackLayout HorizontalOptions="Center" Orientation="Horizontal">
                                    <Label FontSize="20" Text="ðŸŽ“" />
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="16"
                                        Text="GIáº¢I THÃCH CHI TIáº¾T"
                                        TextColor="#F57C00" />
                                </StackLayout>
                                <BoxView
                                    BackgroundColor="#FFB74D"
                                    CornerRadius="1"
                                    HeightRequest="2" />

                                <!--  Thay tháº¿ Label báº±ng WebView  -->
                                <Frame
                                    Padding="0"
                                    BackgroundColor="White"
                                    CornerRadius="15"
                                    HasShadow="True">
                                    <WebView
                                        x:Name="explanationWebViewAudio"
                                        HeightRequest="200"
                                        HorizontalOptions="Fill"
                                        Source="{Binding Explanation, Converter={StaticResource HtmlWrapperConverter}}"
                                        VerticalOptions="Fill" />
                                </Frame>
                            </StackLayout>
                        </Frame>
                    </StackLayout>
                </ScrollView>

                <!--  Action Buttons  -->
                <Frame
                    Grid.Row="2"
                    Margin="5,10"
                    BackgroundColor="#F8F9FA"
                    Style="{StaticResource ModernFrameStyle}">
                    <StackLayout Spacing="20">
                        <Button
                            Command="{Binding SubmitAnswerCommand}"
                            IsVisible="{Binding IsAnswerSubmitted, Converter={StaticResource InverseBooleanConverter}}"
                            Style="{StaticResource PremiumButtonStyle}"
                            Text="ðŸŽ¯ KIá»‚M TRA Káº¾T QUáº¢"
                            TextColor="White">
                            <Button.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                    <GradientStop Offset="0.0" Color="#4CAF50" />
                                    <GradientStop Offset="1.0" Color="#45A049" />
                                </LinearGradientBrush>
                            </Button.Background>
                        </Button>

                        <Grid
                            ColumnDefinitions="*,*"
                            ColumnSpacing="10"
                            RowDefinitions="Auto,Auto"
                            RowSpacing="10">
                            <Button
                                Grid.Row="0"
                                Grid.Column="0"
                                BackgroundColor="#757575"
                                Command="{Binding BindingContext.PrevCommand, Source={x:Reference questionPage}}"
                                IsEnabled="{Binding BindingContext.CanGoPrev, Source={x:Reference questionPage}}"
                                Style="{StaticResource PremiumButtonStyle}"
                                Text="â—€ TrÆ°á»›c"
                                TextColor="White" />
                            <Button
                                Grid.Row="0"
                                Grid.Column="1"
                                BackgroundColor="#2196F3"
                                Command="{Binding BindingContext.NextCommand, Source={x:Reference questionPage}}"
                                IsEnabled="{Binding BindingContext.CanGoNext, Source={x:Reference questionPage}}"
                                Style="{StaticResource PremiumButtonStyle}"
                                Text="Tiáº¿p â–¶"
                                TextColor="White" />
                            <Button
                                Grid.Row="1"
                                Grid.Column="0"
                                BackgroundColor="#FF9800"
                                Command="{Binding BindingContext.CompleteLessonCommand, Source={x:Reference questionPage}}"
                                IsVisible="{Binding BindingContext.IsLastQuestion, Source={x:Reference questionPage}}"
                                Style="{StaticResource PremiumButtonStyle}"
                                Text="ðŸ† HoÃ n thÃ nh"
                                TextColor="White" />
                            <Button
                                Grid.Row="1"
                                Grid.Column="1"
                                BackgroundColor="#9C27B0"
                                Command="{Binding BindingContext.BackToLessonsCommand, Source={x:Reference questionPage}}"
                                IsVisible="{Binding BindingContext.IsCompleted, Source={x:Reference questionPage}}"
                                Style="{StaticResource PremiumButtonStyle}"
                                Text="ðŸ”™ Quay vá»"
                                TextColor="White" />
                        </Grid>
                    </StackLayout>
                </Frame>
            </Grid>
        </DataTemplate>

        <!--  Video Template  -->
        <DataTemplate x:Key="VideoTemplate">
            <Grid
                Padding="10"
                RowDefinitions="Auto,*,Auto"
                RowSpacing="15">
                <!--  Header Section  -->
                <Frame
                    Grid.Row="0"
                    Margin="5,10"
                    BackgroundColor="#1E88E5"
                    Style="{StaticResource ModernFrameStyle}">
                    <Grid RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="12">
                        <StackLayout
                            Grid.Row="0"
                            HorizontalOptions="Center"
                            Orientation="Horizontal">
                            <Label
                                FontSize="24"
                                Text="ðŸŽ¬"
                                VerticalOptions="Center" />
                            <Label
                                FontAttributes="Bold"
                                FontSize="18"
                                Text="CÃ‚U Há»ŽI VIDEO"
                                TextColor="White" />
                        </StackLayout>
                        <!--  Progress Section  -->
                        <Grid
                            Grid.Row="1"
                            ColumnDefinitions="*,Auto,*,Auto,*"
                            ColumnSpacing="15">
                            <StackLayout Grid.Column="0" HorizontalOptions="Start">
                                <Label
                                    FontSize="12"
                                    Opacity="0.8"
                                    Text="ðŸ“Š Tiáº¿n Ä‘á»™"
                                    TextColor="White" />
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="16"
                                    Text="{Binding BindingContext.CurrentIndex, Source={x:Reference questionPage}, Converter={StaticResource IndexToDisplayConverter}}"
                                    TextColor="White" />
                            </StackLayout>
                            <BoxView
                                Grid.Column="1"
                                BackgroundColor="White"
                                Opacity="0.3"
                                WidthRequest="1" />
                            <StackLayout Grid.Column="2" HorizontalOptions="Center">
                                <Label
                                    FontSize="12"
                                    Opacity="0.8"
                                    Text="ðŸŽ¯ Äá»™ khÃ³"
                                    TextColor="White" />
                                <Border
                                    Padding="8,4"
                                    BackgroundColor="#FF6B35"
                                    Stroke="White"
                                    StrokeThickness="1">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="10" />
                                    </Border.StrokeShape>
                                    <Label
                                        FontAttributes="Bold"
                                        FontSize="12"
                                        HorizontalTextAlignment="Center"
                                        Text="{Binding QuestionLevelName}"
                                        TextColor="White" />
                                </Border>
                            </StackLayout>
                            <BoxView
                                Grid.Column="3"
                                BackgroundColor="White"
                                Opacity="0.3"
                                WidthRequest="1" />
                            <StackLayout Grid.Column="4" HorizontalOptions="End">
                                <Label
                                    FontSize="12"
                                    Opacity="0.8"
                                    Text="ðŸ“ Tá»•ng sá»‘"
                                    TextColor="White" />
                                <Label
                                    FontAttributes="Bold"
                                    FontSize="16"
                                    Text="{Binding BindingContext.Questions.Count, Source={x:Reference questionPage}, StringFormat='{0} '}"
                                    TextColor="White" />
                            </StackLayout>
                        </Grid>
                        <!--  Progress Bar  -->
                        <ProgressBar
                            Grid.Row="2"
                            BackgroundColor="#E0E0E0"
                            HeightRequest="8"
                            ProgressColor="#4CAF50">
                            <ProgressBar.Progress>
                                <MultiBinding Converter="{StaticResource ProgressConverter}">
                                    <Binding Path="BindingContext.CurrentIndex" Source="{x:Reference questionPage}" />
                                    <Binding Path="BindingContext.Questions.Count" Source="{x:Reference questionPage}" />
                                </MultiBinding>
                            </ProgressBar.Progress>
                        </ProgressBar>
                        <!--  Question Title  -->
                        <Border
                            Grid.Row="3"
                            Padding="15"
                            BackgroundColor="White"
                            StrokeShape="RoundRectangle 12">
                            <Label
                                MinimumHeightRequest="50"
                                Style="{StaticResource QuestionTitleStyle}"
                                Text="{Binding QuestionText}"
                                TextColor="#2C3E50" />
                        </Border>
                    </Grid>
                </Frame>

                <!--  Main Content Area  -->
                <ScrollView Grid.Row="1">
                    <StackLayout Spacing="20">
                        <!--  Video WebView  -->
                        <Frame Padding="15" Style="{StaticResource ModernFrameStyle}">
                            <Frame
                                Padding="0"
                                CornerRadius="15"
                                HasShadow="True">
                                <Frame.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                        <GradientStop Offset="0.0" Color="#667eea" />
                                        <GradientStop Offset="0.5" Color="#764ba2" />
                                        <GradientStop Offset="1.0" Color="#f093fb" />
                                    </LinearGradientBrush>
                                </Frame.Background>
                                <Grid>
                                    <WebView
                                        x:Name="questionWebViewVideo"
                                        HeightRequest="160"
                                        Source="{Binding QuestionDescription, Converter={StaticResource VideoEmbedHtmlConverter}}"
                                        Style="{StaticResource EnhancedWebViewStyle}" />
                                    <Button
                                        Margin="10"
                                        BackgroundColor="#80000000"
                                        Clicked="OnFullScreenClicked"
                                        CommandParameter="{Binding QuestionDescription}"
                                        CornerRadius="24"
                                        FontSize="24"
                                        HeightRequest="48"
                                        HorizontalOptions="End"
                                        Text="â›¶"
                                        TextColor="White"
                                        VerticalOptions="Start"
                                        WidthRequest="48" />
                                </Grid>

                            </Frame>
                        </Frame>
                    </StackLayout>
                </ScrollView>
                <!--  Action Buttons  -->
                <Frame
                    Grid.Row="2"
                    Margin="5,10"
                    BackgroundColor="#F8F9FA"
                    Style="{StaticResource ModernFrameStyle}">
                    <StackLayout Spacing="20">
                        <Grid
                            ColumnDefinitions="*,*"
                            ColumnSpacing="10"
                            RowDefinitions="Auto,Auto"
                            RowSpacing="10">
                            <Button
                                Grid.Row="0"
                                Grid.Column="0"
                                BackgroundColor="#757575"
                                Command="{Binding BindingContext.PrevCommand, Source={x:Reference questionPage}}"
                                IsEnabled="{Binding BindingContext.CanGoPrev, Source={x:Reference questionPage}}"
                                Style="{StaticResource PremiumButtonStyle}"
                                Text="â—€ TrÆ°á»›c"
                                TextColor="White" />
                            <Button
                                Grid.Row="0"
                                Grid.Column="1"
                                BackgroundColor="#2196F3"
                                Command="{Binding BindingContext.NextCommand, Source={x:Reference questionPage}}"
                                IsEnabled="{Binding BindingContext.CanGoNext, Source={x:Reference questionPage}}"
                                Style="{StaticResource PremiumButtonStyle}"
                                Text="Tiáº¿p â–¶"
                                TextColor="White" />
                            <Button
                                Grid.Row="1"
                                Grid.Column="0"
                                BackgroundColor="#FF9800"
                                Command="{Binding BindingContext.CompleteLessonCommand, Source={x:Reference questionPage}}"
                                IsVisible="{Binding BindingContext.IsLastQuestion, Source={x:Reference questionPage}}"
                                Style="{StaticResource PremiumButtonStyle}"
                                Text="ðŸ† HoÃ n thÃ nh"
                                TextColor="White" />
                            <Button
                                Grid.Row="1"
                                Grid.Column="1"
                                BackgroundColor="#9C27B0"
                                Command="{Binding BindingContext.BackToLessonsCommand, Source={x:Reference questionPage}}"
                                IsVisible="{Binding BindingContext.IsCompleted, Source={x:Reference questionPage}}"
                                Style="{StaticResource PremiumButtonStyle}"
                                Text="ðŸ”™ Quay vá»"
                                TextColor="White" />
                        </Grid>
                    </StackLayout>
                </Frame>
            </Grid>
        </DataTemplate>

        <!--  TextTemplate & BlankTemplate khÃ´ng Ä‘á»•i  -->
        <DataTemplate x:Key="TextTemplate">
            <Label
                FontSize="18"
                LineBreakMode="WordWrap"
                Text="{Binding .}"
                TextColor="#2C3E50"
                VerticalOptions="Center" />
        </DataTemplate>
        <DataTemplate x:Key="BlankTemplate">
            <Border
                Margin="0,0,4,0"
                Padding="0"
                BackgroundColor="White"
                Stroke="{Binding BorderColor}"
                StrokeThickness="1">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="8" />
                </Border.StrokeShape>
                <Entry
                    Placeholder="___"
                    Text="{Binding UserText, Mode=TwoWay}"
                    WidthRequest="80" />
            </Border>
        </DataTemplate>
        <sel:SegmentTemplateSelector
            x:Key="SegmentTemplateSelector"
            BlankTemplate="{StaticResource BlankTemplate}"
            TextTemplate="{StaticResource TextTemplate}" />

        <!--  Selector  -->
        <sel:QuestionTemplateSelector
            x:Key="QuestionSelector"
            AudioTemplate="{StaticResource AudioTemplate}"
            FillBlankTemplate="{StaticResource FillBlankTemplate}"
            MCQTemplate="{StaticResource MCQTemplate}"
            TrueFalseTemplate="{StaticResource TFTemplate}"
            VideoTemplate="{StaticResource VideoTemplate}" />
    </ContentPage.Resources>

    <ScrollView x:Name="MainScrollView">
        <VerticalStackLayout
            Padding="5"
            BindableLayout.ItemTemplateSelector="{StaticResource QuestionSelector}"
            BindableLayout.ItemsSource="{Binding CurrentQuestionCollection}"
            Spacing="10" />
    </ScrollView>
</ContentPage>
