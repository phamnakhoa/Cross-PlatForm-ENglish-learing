@using WebLuanVan_ASP.NET_MVC.Areas.Admin.Models;
@using WebLuanVan_ASP.NET_MVC.Areas.UpdateProfile.Models;

@{
    var firstBanner = (ViewBag.Banner as List<CBanner>)?.FirstOrDefault(b => b.IsActive ?? false);
    var userProfile = ViewBag.UserProfile as UserProfile;
}
<!DOCTYPE html>
<html lang="en">

<!-- Mirrored from themes.iamabdus.com/royal/1.3/index.html by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 25 Sep 2019 12:12:09 GMT -->
<!-- Added by HTTrack -->
<meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <title>LK Learning</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&family=Poppins:wght@200;300;400;500;600&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="~/UserTemplate/lib/animate/animate.min.css" rel="stylesheet">
    <link href="~/UserTemplate/lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">


    <!-- Customized Bootstrap Stylesheet -->
    <link href="~/UserTemplate/css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="~/UserTemplate/css/style.css" rel="stylesheet">
    @RenderSection("Styles", required: false)

</head>
<body>

    <!-- Spinner Start -->
    <div id="spinner" class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
        <div class="spinner-border text-secondary" style="width: 3rem; height: 3rem;" role="status">
            <span class="sr-only">Đang tải...</span>
        </div>
    </div>


    <!-- Topbar End -->
    <!-- Navbar & Hero Start -->
    <div class="container-fluid nav-bar p-0">
        <nav class="navbar navbar-expand-lg navbar-light bg-white px-4 px-lg-5 py-3 py-lg-0">
            <a asp-area="User" asp-action="Index" asp-controller="Dashboard" class="navbar-brand p-0">
                <h1 class="display-5 text-secondary m-0">
                    <img src="~/AdminTL/assets/images/logo1.gif" class="img-fluid" alt="">
                </h1>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
                <span class="fa fa-bars"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarCollapse">
                <div class="nav-item dropdown">
                    <a href="#" class="nav-link" data-bs-toggle="dropdown">
                        <span class="dropdown-toggle"><i class="fas fa-search"></i> Tìm từ vựng</span>
                    </a>
                    <div class="dropdown-menu p-3" style="min-width: 320px;">
                        <form id="vocabSearchForm" autocomplete="off">
                            <div class="input-group">
                                <input type="search" id="vocabSearchInput" name="q" class="form-control rounded-pill" placeholder="Nhập từ muốn tìm..." aria-label="Tìm từ vựng" />
                                <button class="btn btn-primary rounded-pill ms-2" type="submit">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </form>
                        <div id="vocabSuggestionList" class="vocab-suggestion-list" style="display:none;"></div>
                        <div id="vocabSearchResults" style="display:none;"></div>
                    </div>
                </div>

                <div class="navbar-nav ms-auto py-0">
                    <a asp-area="User" asp-action="Index" asp-controller="Dashboard" class="nav-item nav-link active">Trang chủ</a>
                    <a asp-area="User" asp-action="Index" asp-controller="Package" class="nav-item nav-link">Gói cước</a>
                    <a asp-area="User" asp-action="Index" asp-controller="Certificate" class="nav-item nav-link">Chứng chỉ</a>
                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link" data-bs-toggle="dropdown">
                            <span class="dropdown-toggle">Danh mục</span>
                        </a>
                        <div class="dropdown-menu m-0">
                            @if (ViewBag.Categories is List<CCategory> categories && categories.Any())
                            {
                                foreach (var category in categories)
                                {
                                    <a href="@Url.Action("Index", "Course", new { area = "User", categoryId = category.CategoryId })" class="dropdown-item">
                                        @category.CategoryName
                                    </a>
                                }
                            }
                            else
                            {
                                <span class="dropdown-item text-muted">Không có danh mục</span>
                            }
                        </div>
                    </div>
                    <a asp-area="User" asp-controller="Library" asp-action="Index" class="nav-item nav-link">Thư viện</a>
                    <!-- Vocabulary Search as nav-item dropdown with AJAX results -->

                </div>
                @if (userProfile != null)
                {
                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                            <i class="fa fa-user"></i> @(userProfile.Fullname ?? "Guest")
                        </a>
                        <div class="dropdown-menu dropdown-menu-end">
                            <a asp-controller="Profile" asp-action="Index" asp-area="User" class="dropdown-item">Lịch sử hoạt động</a>

                            <a asp-controller="UpdateProfile" asp-action="Index" asp-area="Update" class="dropdown-item">Cập nhật</a>
                            <a asp-controller="Dashboard" asp-action="Logout" class="dropdown-item">Đăng xuất</a>
                        </div>
                    </div>
                }
                else
                {
                    <div class="nav-item">
                        <a asp-action="Index" asp-area="Login" asp-controller="LogIn" class="btn btn-primary border-secondary rounded-pill py-2 px-4 px-lg-3 mb-3 mb-md-3 mb-lg-0">Đăng nhập</a>
                    </div>
                }
            </div>
        </nav>
    </div>
    <!-- Navbar & Hero End -->






    @RenderBody()
    <!-- Copyright Start -->
    <div class="container-fluid copyright py-4">
        <div class="container">
            <div class="row g-4 align-items-center">
                <div class="col-md-6 text-center text-md-start mb-md-0">
                    <span class="text-white">Võ Thanh Trường Long - DH52111246</span>
                </div>
                <div class="col-md-6 text-center text-md-end text-white">

                    <span class="text-white">Phạm Nguyễn Anh Khoa - DH52111146</span>

                </div>
            </div>
        </div>
    </div>
    <!-- Copyright End -->
    <!-- Back to Top -->
    <a href="#" class="btn btn-primary btn-lg-square back-to-top"><i class="fa fa-arrow-up"></i></a>


    <!-- JavaScript Libraries -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/UserTemplate/lib/wow/wow.min.js"></script>
    <script src="~/UserTemplate/lib/easing/easing.min.js"></script>
    <script src="~/UserTemplate/lib/waypoints/waypoints.min.js"></script>
    <script src="~/UserTemplate/lib/counterup/counterup.min.js"></script>
    <script src="~/UserTemplate/lib/owlcarousel/owl.carousel.min.js"></script>


    <!-- Template Javascript -->
    <script src="~/UserTemplate/js/main.js"></script>


    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.22.0/dist/sweetalert2.all.min.js"></script>

    <script>
        function toggleChatBox() {
            var box = document.getElementById('floatingChatBox');
            var frame = document.getElementById('chatFrame');
            if (box.style.display === 'none' || box.style.display === '') {
                // Gọi API kiểm tra/tạo cuộc trò chuyện trước khi mở chat
                fetch('/User/Chat/GetOrCreateConversation', { method: 'POST' })
                    .then(res => res.json())
                    .then(data => {
                        if (data && data.conversationId && data.userId) {
                            frame.src = '/User/Chat/Chat?conversationId=' + data.conversationId + '&userId=' + data.userId;
                            box.style.display = 'block';
                        } else {
                            alert('Không thể tạo cuộc trò chuyện.');
                        }
                    });
            } else {
                box.style.display = 'none';
                frame.src = '';
            }
        }
    </script>

    <!-- Floating Chat Button & Box -->
    <div id="floatingChatBtn" style="position:fixed;bottom:32px;right:32px;z-index:9999;">
        <button class="btn btn-primary" style="border-radius:50%;width:56px;height:56px;font-size:24px;" onclick="toggleChatBox()">
            <i class="fa fa-comments"></i>
        </button>
    </div>
    <div id="floatingChatBox" style="display:none;position:fixed;bottom:100px;right:32px;z-index:10000;width:370px;max-width:98vw;box-shadow:0 8px 32px rgba(0,0,0,0.18);border-radius:18px;overflow:hidden;">
        <iframe id="chatFrame"
                src=""
                style="width:100%;height:480px;border:none;outline:none;border-radius:18px;background:#fff;box-shadow:none;"
                frameborder="0"
                allowtransparency="true"></iframe>
    </div>



    @Html.Partial("~/Areas/Admin/Views/Shared/_DeleteConfirmation.cshtml")
    @RenderSection("Scripts", required: false)


</body>

<!-- Mirrored from themes.iamabdus.com/royal/1.3/index.html by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 25 Sep 2019 12:12:33 GMT -->
</html>

<script>
    $(document).ready(function () {
        // Show suggestions as you type
    $('#vocabSearchInput').on('keyup', function () {
        var query = $(this).val().trim();
        if (!query) {
            $('#vocabSuggestionList').hide();
            $('#vocabSearchResults').hide();
            return;
        }
        // First, get suggestions from DB
        $.get('/User/Dashboard/VocabularySuggestionAjax', { q: query }, function (data) {
            var foundExact = data.some(function (item) {
                return item.word.toLowerCase() === query.toLowerCase();
            });
            var html = '<ul class="list-group">';
            data.forEach(function (item) {
                html += '<li class="list-group-item list-group-item-action" style="cursor:pointer;" onclick="showVocabDetail(' + item.vocabularyId + ', \'' + item.word.replace(/'/g, "\\'") + '\')">' + item.word + '</li>';
            });
            html += '</ul>';
            $('#vocabSuggestionList').html(html).show();
            $('#vocabSearchResults').hide();

            // If not found, auto-crawl from API
            if (!foundExact) {
                $.get('/User/Dashboard/VocabularyDetailAjax', { id: 0, word: query }, function (data) {
                    // Optionally, refresh suggestions after crawl
                    $('#vocabSearchResults').html(data).show();
                    // Or, you can re-trigger the suggestion AJAX to update the list
                });
            }
        });
    });


        // Hide suggestions and popup when clicking outside
        $(document).on('click', function (e) {
            if (!$(e.target).closest('#vocabSearchInput, #vocabSuggestionList, #vocabSearchResults').length) {
                $('#vocabSuggestionList').hide();
                $('#vocabSearchResults').hide();
            }
        });

        // Show suggestions when input is focused and has value
        $('#vocabSearchInput').on('focus', function () {
            if ($(this).val().trim()) {
                $('#vocabSuggestionList').show();
            }
        });
    });

    // Show popup with full details
    function showVocabDetail(id, word) {
        $('#vocabSearchResults').show().html('<div class="text-center text-secondary py-2"><i class="fa fa-spinner fa-spin"></i> Đang tải chi tiết...</div>');
        $.get('/User/Dashboard/VocabularyDetailAjax', { id: id, word: word }, function (data) {
            $('#vocabSearchResults').html(data).show();
            $('#vocabSuggestionList').hide();
        });
    }

</script>

