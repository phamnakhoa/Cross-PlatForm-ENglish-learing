@using WebLuanVan_ASP.NET_MVC.Areas.Admin.Services.Solana
@{
    ViewData["Title"] = "Xác thực chứng chỉ";
    Layout = "~/Areas/User/Views/Shared/_LayoutKhung.cshtml";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-7">
            <div class="card shadow-sm mb-4">
                <div class="card-header  text-white">
                    <h4 class="mb-0"><i class="fas fa-certificate me-2"></i>Kiểm tra/Xác thực chứng chỉ</h4>
                </div>
                <div class="card-body">
                    <form id="verifyForm" autocomplete="off">
                        <div class="mb-3">
                            <label for="verifyCode" class="form-label fw-bold text-dark">Nhập mã xác thực chứng chỉ</label>
                            <input type="text" class="form-control" id="verifyCode" name="verifyCode" placeholder="Nhập mã chứng chỉ..." required maxlength="50" />
                        </div>
                        <button type="submit" class="btn btn-primary">Kiểm tra</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.22.0/dist/sweetalert2.all.min.js"></script>
    <script>
        document.getElementById('verifyForm').addEventListener('submit', function (e) {
            e.preventDefault();
            var code = document.getElementById('verifyCode').value.trim();
            if (!code) {
                Swal.fire('Lỗi', 'Vui lòng nhập mã xác thực.', 'error');
                return;
            }
            Swal.fire({
                title: 'Đang xác thực...',
                html: '<div class="spinner-border text-primary"></div>',
                showConfirmButton: false,
                allowOutsideClick: false,
                didOpen: () => {
                    fetch('@Url.Action("Verify", "Certificate", new { area = "User" })', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ VerifyCode: code })
                    })
                    .then(response => response.json())
                    .then(data => {
                        let html = `<div><b>${data.message || 'Không xác thực được chứng chỉ.'}</b></div>`;
                        if (data.imageUrl) {
                            html += `<div class="mt-2"><img src="${data.imageUrl}" style="max-width:300px;border-radius:8px;" /></div>`;
                        }
                        if (data.expiration) {
                            html += `<div class="mt-2"><span class="badge bg-info">${data.expiration}</span></div>`;
                        }
                        Swal.fire({
                            title: 'Kết quả xác thực',
                            html: html,
                            icon: data.message && data.message.includes('thật') ? 'success' : 'error'
                        });
                    })
                    .catch(() => {
                        Swal.fire('Lỗi', 'Không thể xác thực chứng chỉ.', 'error');
                    });
                }
            });
        });
    </script>
}
