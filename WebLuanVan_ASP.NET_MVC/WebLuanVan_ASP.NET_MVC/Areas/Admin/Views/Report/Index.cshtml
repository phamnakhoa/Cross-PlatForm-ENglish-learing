@using Microsoft.AspNetCore.Html
@using WebLuanVan_ASP.NET_MVC.Areas.Admin.Models
@model IEnumerable<WebLuanVan_ASP.NET_MVC.Areas.Admin.Models.CReview>

@{
    ViewData["Title"] = "Quản lý báo cáo";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

@{
    var reportTypes = ViewBag.ReportTypes as List<CReview> ?? new List<CReview>();
    int? currentReportType = ViewBag.CurrentType;
}

@{
    Paginate paginate = ViewBag.Paginate ?? new Paginate();
    int pageNo = paginate.CurrentPage;
}
<link rel="stylesheet" href="~/AdminTL/assets/css/index.css">

<div class="content-header">
    <h1>Quản lý báo cáo</h1>
</div>
<div class="card mb-4">
    <div class="card-header">
        <h5>Bộ lọc</h5>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3" asp-action="Index" asp-controller="Report">
            <div class="col-12 col-md-3">
                <label class="form-label">Loại báo cáo</label>
                <select id="typeSelect" name="type" class="form-select select2">
                    <option value="">-- Tất cả báo cáo --</option>
                    <option value="2" selected="@(currentReportType == 2)">Báo cáo bài học</option>
                    <option value="3" selected="@(currentReportType == 3)">Báo cáo khóa học</option>
                </select>
            </div>
            <div class="col-12 col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100 w-md-auto">Lọc</button>
                @if (currentReportType.HasValue)
                {
                    <a asp-action="Index" class="btn btn-outline-secondary ms-2 w-100 w-md-auto">Xóa lọc</a>
                }
            </div>
        </form>
    </div>
</div>
<div class="d-flex justify-content-between align-items-center mt-4 mb-3">
    <h2>Danh sách báo cáo</h2>
    <div>
        <button id="deleteSelected" class="btn btn-danger mr-2" disabled>Xóa đã chọn</button>
        <a asp-action="formThemReport" class="btn btn-primary">Thêm báo cáo</a>
    </div>
</div>
<form id="deleteForm" asp-action="DeleteMultiple" method="post">
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-light">
                <tr>
                    <th width="50px"><input type="checkbox" id="selectAll" /></th>
                    <th>Người dùng</th>
                    <th>Khóa học</th>
                    <th>Bài học</th>
                    <th>Loại</th>
                    <th>Góp ý</th>
                    <th>Ngày tạo</th>
                    <th width="180px">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @if (!Model.Any())
                {
                    <tr>
                        <td colspan="7" class="text-center">Không có báo cáo nào.</td>
                    </tr>
                }
                else
                {
                    @foreach (var report in Model)
                    {
                        <tr>
                            <td><input type="checkbox" name="selectedIds" value="@report.ReviewId" class="rowCheckbox" /></td>
                            <td>@report.Name</td>
                            <td>@report.CourseName</td>
                            <td>@(report.LessonName ?? "N/A")</td>
                            <td>@(report.ReviewType == "2" ? "Báo cáo bài học" : "Báo cáo khóa học")</td>
                            <td>@report.Comment</td>
                            <td>@report.CreatedAt?.ToString("dd/MM/yyyy")</td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a asp-action="xoaReport" asp-route-id="@report.ReviewId" onclick="return confirmDelete(event)" class="btn btn-danger">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                    <a asp-action="viewDetail" asp-route-id="@report.ReviewId" class="btn btn-info">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                   
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</form>
<partial name="_Paging" model="@paginate" />

<style>
    .star-filled {
        color: #FFC107;
        margin-right: 2px;
    }

    .star-empty {
        color: #e0e0e0;
        margin-right: 2px;
    }

    .table td .fa-star {
        font-size: 1.2em;
        vertical-align: middle;
    }
</style>

@section Scripts {
    <script>
        $(document).ready(function () {
            $('.select2').select2({
                theme: 'bootstrap-5',
                placeholder: 'Chọn loại báo cáo',
                allowClear: true,
                width: '100%'
            });

            $('#selectAll').change(function () {
                $('.rowCheckbox').prop('checked', $(this).prop('checked'));
                toggleDeleteButton();
            });

            $('.rowCheckbox').change(function () {
                if ($('.rowCheckbox:checked').length === $('.rowCheckbox').length) {
                    $('#selectAll').prop('checked', true);
                } else {
                    $('#selectAll').prop('checked', false);
                }
                toggleDeleteButton();
            });

            function toggleDeleteButton() {
                var checkedCount = $('.rowCheckbox:checked').length;
                $('#deleteSelected').prop('disabled', checkedCount === 0);
                $('#deleteSelected').text(checkedCount > 0 ? `Xóa (${checkedCount}) đã chọn` : 'Xóa đã chọn');
            }

            $('#deleteSelected').click(function (e) {
                e.preventDefault();
                confirmDeleteMultiple(e, function () {
                    $('#deleteForm').submit();
                });
            });

            function confirmDelete(event) {
                event.preventDefault();
                if (confirm("Bạn có chắc muốn xóa báo cáo này?")) {
                    window.location.href = event.currentTarget.href;
                }
                return false;
            }
        });
    </script>
}