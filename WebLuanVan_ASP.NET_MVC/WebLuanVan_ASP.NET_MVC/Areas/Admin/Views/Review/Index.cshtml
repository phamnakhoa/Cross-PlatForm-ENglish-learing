@using Microsoft.AspNetCore.Html
@using WebLuanVan_ASP.NET_MVC.Areas.Admin.Models
@model IEnumerable<WebLuanVan_ASP.NET_MVC.Areas.Admin.Models.CReview>

@{
    ViewData["Title"] = "Quản lý đánh giá";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

@{
    var ratings = ViewBag.Ratings as List<CReview> ?? new List<CReview>();
    int? currentReviewRating = ViewBag.CurrentRating;
}

@{
    Paginate paginate = ViewBag.Paginate ?? new Paginate();
    int pageNo = paginate.CurrentPage;
}
@functions {
    public IHtmlContent RenderStars(int rating, int max = 5)
    {
        var sb = new System.Text.StringBuilder();
        for (int i = 1; i <= max; i++)
        {
            if (i <= rating)
                sb.Append("<i class='fas fa-star star-filled'></i>");
            else
                sb.Append("<i class='fas fa-star star-empty'></i>");
        }
        return new HtmlString(sb.ToString());
    }
}
<link rel="stylesheet" href="~/AdminTL/assets/css/index.css">

<div class="content-header">
    <h1>Quản lý đánh giá</h1>
</div>
<div class="card mb-4">
    <div class="card-header">
        <h5>Bộ lọc</h5>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3" asp-action="Index" asp-controller="Report">
            <div class="col-12 col-md-3">
                <label class="form-label">Loại báo cáo</label>
                <select id="categorySelect" name="rating" class="form-select select2">
                    <option value="">-- Tất cả đánh giá --</option>
                    @foreach (var rating in ratings)
                    {
                        <option value="@rating.Rating" selected="@(currentReviewRating == rating.Rating)">@rating.Rating sao</option>
                    }
                </select>
            </div>
            <div class="col-12 col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100 w-md-auto">Lọc</button>
                @if (currentReviewRating.HasValue)
                {
                    <a asp-action="Index" class="btn btn-outline-secondary ms-2">Xóa lọc</a>
                }
            </div>
        </form>
    </div>
</div>
<div class="d-flex justify-content-between align-items-center mt-4 mb-3">
    <h2>Danh sách đánh giá</h2>
    <div>
        <button id="deleteSelected" class="btn btn-danger mr-2" disabled>Xóa đã chọn</button>
        <a asp-action="formThemReview" class="btn btn-primary">Thêm đánh giá</a>
    </div>
</div>
<form id="deleteForm" asp-action="DeleteMultiple" method="post">
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-light">
                <tr>
                    <th width="50px"><input type="checkbox" id="selectAll" /></th>
                    <th>Người dùng</th>
                    <th>Tên Khóa học</th>
                    <th>Đánh giá</th>
                    <th>Bình luận</th>
                    <th>Ngày tạo</th>
                    <th width="180px">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @if (!Model.Any())
                {
                    <tr>
                        <td colspan="6" class="text-center">Không có đánh giá nào.</td>
                    </tr>
                }
                else
                {
                    @foreach (var review in Model)
                    {
                        <tr>
                            <td><input type="checkbox" name="selectedIds" value="@review.ReviewId" class="rowCheckbox" /></td>
                            <td>@review.Name</td>
							<td>@review.CourseName</td>
                            <td>@RenderStars(review.Rating)</td>
                            <td>@review.Comment</td>
                            <td>@review.CreatedAt?.ToString("dd/MM/yyyy")</td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a asp-action="xoaReview" asp-route-id="@review.ReviewId" onclick="return confirmDelete(event)" class="btn btn-danger">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                    <a asp-action="viewDetail" asp-route-id="@review.ReviewId" class="btn btn-info">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a asp-action="formSuaReview" asp-route-id="@review.ReviewId" class="btn btn-warning">
                                        <i class="fas fa-edit"></i>
                                    </a>

                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</form>
<!-- Phân trang -->
<partial name="_Paging" model="@paginate" />

<style>
    .star-filled {
        color: #FFC107;
        margin-right: 2px;
    }
    .star-empty {
        color: #e0e0e0;
        margin-right: 2px;
    }
    .table td .fa-star {
        font-size: 1.2em;
        vertical-align: middle;
    }
    /* Optional: make filter stars smaller */
    select option .fa-star {
        font-size: 1em;
    }
</style>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Khởi tạo Select2
            $('.select2').select2({
                theme: 'bootstrap-5',
                placeholder: 'Chọn số sao',
                allowClear: true,
                width: '100%'
            });

            // Xử lý chọn tất cả
            $('#selectAll').change(function () {
                $('.rowCheckbox').prop('checked', $(this).prop('checked'));
                toggleDeleteButton();
            });

            $('.rowCheckbox').change(function () {
                if ($('.rowCheckbox:checked').length === $('.rowCheckbox').length) {
                    $('#selectAll').prop('checked', true);
                } else {
                    $('#selectAll').prop('checked', false);
                }
                toggleDeleteButton();
            });

            function toggleDeleteButton() {
                var checkedCount = $('.rowCheckbox:checked').length;
                $('#deleteSelected').prop('disabled', checkedCount === 0);
                $('#deleteSelected').text(checkedCount > 0 ? `Xóa (${checkedCount}) đã chọn` : 'Xóa đã chọn');
            }

            // Delete multiple handler
            $('#deleteSelected').click(function (e) {
                e.preventDefault();
                confirmDeleteMultiple(e, function () {
                    $('#deleteForm').submit();
                });
            });

            // Confirm delete
            function confirmDelete(event) {
                event.preventDefault();
                if (confirm("Bạn có chắc muốn xóa đánh giá này?")) {
                    window.location.href = event.currentTarget.href;
                }
                return false;
            }
        });
    </script>
}